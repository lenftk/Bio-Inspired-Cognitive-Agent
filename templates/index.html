<!DOCTYPE html>
<html>
<head>
    <title>Digital Organism Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #1a1a1a; color: #e0e0e0; font-family: 'Courier New', monospace; display: flex; height: 100vh; margin: 0; }
        .sidebar { width: 30%; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .chat-area { width: 70%; padding: 20px; display: flex; flex-direction: column; }
        
        .card { background: #2d2d2d; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; font-size: 1.2em; color: #4CAF50; }
        
        #thought-box { font-style: italic; color: #888; min-height: 40px; }
        #log-box { height: 150px; overflow-y: auto; font-size: 0.8em; color: #aaa; }
        
        #chat-history { flex-grow: 1; overflow-y: auto; margin-bottom: 20px; border: 1px solid #333; padding: 10px; border-radius: 5px; }
        .msg { margin-bottom: 10px; padding: 8px; border-radius: 5px; max-width: 80%; }
        .user { background: #3d5afe; align-self: flex-end; margin-left: auto; text-align: right; }
        .agent { background: #2d2d2d; align-self: flex-start; }
        
        input { padding: 10px; background: #333; border: none; color: white; width: 100%; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="card">
            <h2>ðŸ§  Neural Status</h2>
            <div id="status-text">STATUS: IDLE</div>
            <canvas id="hormoneChart"></canvas>
        </div>
        <div class="card">
            <h2>ðŸ’­ Inner Thought (CoT)</h2>
            <div id="thought-box">Waiting for stimulus...</div>
        </div>
        <div class="card">
            <h2>ðŸ“œ System Logs</h2>
            <div id="log-box"></div>
        </div>
    </div>
    
    <div class="chat-area">
        <div id="chat-history"></div>
        <input type="text" id="user-input" placeholder="Say something... (Press Enter)" autofocus>
    </div>

    <script>
        const ws = new WebSocket("ws://" + location.host + "/ws");
        const chatHistory = document.getElementById("chat-history");
        const thoughtBox = document.getElementById("thought-box");
        const logBox = document.getElementById("log-box");
        const statusText = document.getElementById("status-text");
        
        let currentAgentMsg = null;

        // Chart Setup
        const ctx = document.getElementById('hormoneChart').getContext('2d');
        const hormoneChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Stress', 'Dopamine'],
                datasets: [{
                    label: 'Levels',
                    data: [0.2, 0.5],
                    backgroundColor: ['#ff5252', '#69f0ae']
                }]
            },
            options: { scales: { y: { beginAtZero: true, max: 1.0 } } }
        });

        ws.onmessage = function(event) {
            const data = JSON.parse(event.data);
            
            if (data.type === "status_update") {
                statusText.innerText = "STATUS: " + data.status;
                hormoneChart.data.datasets[0].data = [data.hormones.stress, data.hormones.dopamine];
                hormoneChart.update();
            } else if (data.type === "thought") {
                thoughtBox.innerText = data.text;
                addLog("Thinking: " + data.text);
            } else if (data.type === "log") {
                addLog(data.msg);
            } else if (data.type === "agent_msg") {
                // Proactive message
                addMessage("Agent", data.text, "agent");
            } else if (data.type === "stream") {
                if (!currentAgentMsg) {
                    currentAgentMsg = createMessageElement("agent");
                }
                currentAgentMsg.innerText += data.token;
                chatHistory.scrollTop = chatHistory.scrollHeight;
            } else if (data.type === "stream_end") {
                currentAgentMsg = null;
            }
        };

        document.getElementById("user-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                const msg = this.value;
                if (!msg) return;
                addMessage("User", msg, "user");
                ws.send(JSON.stringify({message: msg}));
                this.value = "";
            }
        });

        function addMessage(role, text, className) {
            const div = document.createElement("div");
            div.className = "msg " + className;
            div.innerText = text;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function createMessageElement(className) {
            const div = document.createElement("div");
            div.className = "msg " + className;
            chatHistory.appendChild(div);
            return div;
        }

        function addLog(text) {
            const div = document.createElement("div");
            div.innerText = "> " + text;
            logBox.prepend(div);
        }
    </script>
</body>
</html>